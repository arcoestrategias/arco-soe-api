// ============================================================================
// Prisma Client & Datasource
// ============================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CONVENCIONES Y NOMENCLATURA — SOE BACKEND
// ----------------------------------------------------------------------------
// Nombres de modelos:
// - Inglés, PascalCase (Company, BusinessUnit, UserPermission)
//
// Relaciones y campos inversos (buena práctica):
// - Prisma permite 1:N unidireccionales, pero **mantenemos inversos** para
//   claridad de navegación, legibilidad y consistencia.
//
// Multiempresa:
// - Cada Company puede tener varias BusinessUnit
// - Contexto de usuario con UserBusinessUnit (composite key)
//
// Acceso:
// - UserPermission otorga permisos efectivos; Role es plantilla
//
// Estilo:
// - Campos camelCase, Tablas PascalCase
// - Auditoría: isActive, createdBy, updatedBy, createdAt, updatedAt
// ============================================================================

// ============================================================================
// CORE: Company, BusinessUnit, Position, Roles & Permissions, Users
// ============================================================================

/// Organización (tenant). Agrupa unidades de negocio.
model Company {
  id                      String  @id @default(uuid()) @db.Uuid
  name                    String  @db.VarChar(500)
  description             String? @db.VarChar(1000)
  ide                     String  @db.VarChar(13)
  legalRepresentativeName String? @db.VarChar(250)
  address                 String? @db.VarChar(250)
  phone                   String? @db.VarChar(50)
  order                   Int?
  isPrivate               Boolean @default(false)
  isGroup                 Boolean @default(false)

  // Relaciones 1:N
  businessUnits BusinessUnit[]
  userCompanies UserCompany[]

  // Inversos para módulos de Sistema/Notificaciones
  systemSettings SystemSetting[] // inverso de SystemSetting.company
  notifications  Notification[] // inverso de Notification.company
  meetings       Meeting[] // inverso de Meeting.company

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Unidad de negocio. Contiene posiciones, planes, etc.
model BusinessUnit {
  id                      String  @id @default(uuid()) @db.Uuid
  name                    String  @db.VarChar(500)
  description             String? @db.VarChar(1000)
  ide                     String? @db.VarChar(13)
  legalRepresentativeName String? @db.VarChar(250)
  address                 String? @db.VarChar(250)
  phone                   String? @db.VarChar(50)
  order                   Int?
  isMain                  Boolean @default(false)

  // Relación con Company
  companyId String  @db.Uuid
  company   Company @relation(fields: [companyId], references: [id])

  // Relaciones 1:N
  positions       Position[]
  userLinks       UserBusinessUnit[]
  userPermissions UserPermission[]
  strategicPlans  StrategicPlan[]

  // Inversos para módulos de Sistema/Notificaciones
  systemSettings SystemSetting[] // inverso de SystemSetting.businessUnit
  notifications  Notification[] // inverso de Notification.businessUnit
  meetings       Meeting[] // inverso de Meeting.businessUnit

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Cargo/posición. Puede ligarse a objetivos, proyectos, prioridades, palancas.
model Position {
  id   String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(500)

  // Pertenencia a BU
  businessUnitId String       @db.Uuid
  businessUnit   BusinessUnit @relation(fields: [businessUnitId], references: [id])

  // Relaciones con usuarios y planes
  userLinks       UserBusinessUnit[]
  strategicPlanId String?            @db.Uuid
  strategicPlan   StrategicPlan?     @relation(fields: [strategicPlanId], references: [id])

  // Jerarquía interna de posiciones
  mission    String?
  vision     String?
  department String?
  isCeo      Boolean @default(false)

  positionSuperiorId String?    @db.Uuid
  superior           Position?  @relation("PositionHierarchy", fields: [positionSuperiorId], references: [id])
  subordinates       Position[] @relation("PositionHierarchy")

  // Otras relaciones
  projectParticipants ProjectParticipant[]
  priorities          Priority[]
  levers              Lever[]
  objectives          Objective[]
  strategicProjects   StrategicProject[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessUnitId])
}

/// Plantilla de rol (no ejecuta permisos en runtime; se copian a UserPermission).
model Role {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?

  // Relación con permisos (m2m explícita)
  permissions RolePermission[]

  // Usuarios vinculados (contexto BU)
  userLinks UserBusinessUnit[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Módulos funcionales del sistema
model Module {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  shortCode   String  @unique
  description String?

  // Relación con permisos
  permissions Permission[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Permiso granular asociado a un módulo.
model Permission {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?

  moduleId String @db.Uuid
  module   Module @relation(fields: [moduleId], references: [id])

  // Relaciones intermedias
  roleLinks RolePermission[]
  userLinks UserPermission[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Relación m2m explícita entre Role y Permission (plantillas).
model RolePermission {
  id String @id @default(uuid()) @db.Uuid

  roleId       String     @db.Uuid
  permissionId String     @db.Uuid
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Usuario del sistema (multi-empresa).
model User {
  id        String  @id @default(uuid()) @db.Uuid
  email     String  @unique
  username  String? @unique
  ide       String  @unique
  telephone String?
  firstName String
  lastName  String
  password  String

  // Contexto multi-empresa
  userCompanies     UserCompany[]
  userBusinessUnits UserBusinessUnit[]
  userPermissions   UserPermission[]

  // Admin plataforma
  isPlatformAdmin Boolean @default(false)

  // Seguridad / tokens
  tokenInvalidBeforeAt  DateTime?
  resetToken            String?   @db.VarChar(255)
  resetTokenExpiresAt   DateTime?
  isEmailConfirmed      Boolean   @default(false)
  emailConfirmToken     String?   @db.VarChar(255)
  emailConfirmExpiresAt DateTime?

  lastLoginAt   DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // Inverso de Notificaciones recibidas
  notificationsReceived Notification[] // ← inverso de Notification.recipient

  // Relaciones para el módulo de Reuniones
  meetingsCreated       Meeting[]              @relation("MeetingCreator")
  meetingsParticipating MeetingParticipant[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Asociación Usuario-Compañía.
model UserCompany {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String  @db.Uuid
  companyId String  @db.Uuid
  isManager Boolean @default(false)

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@unique([userId, companyId])
}

/// Asociación Usuario-BusinessUnit (contexto operativo).
model UserBusinessUnit {
  userId         String  @db.Uuid
  businessUnitId String  @db.Uuid
  positionId     String? @db.Uuid
  roleId         String? @db.Uuid
  isResponsible  Boolean @default(false)

  user         User         @relation(fields: [userId], references: [id])
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id])
  position     Position?    @relation(fields: [positionId], references: [id])
  role         Role?        @relation(fields: [roleId], references: [id])

  @@id([userId, businessUnitId]) // un registro por usuario y BU
  @@unique([positionId]) // una posición no puede tener 2 usuarios (permite null duplicado)
  @@index([businessUnitId])
  @@index([userId])
}

/// Permisos efectivos por usuario y BU (override a plantillas).
model UserPermission {
  id             String  @id @default(uuid()) @db.Uuid
  userId         String  @db.Uuid
  businessUnitId String  @db.Uuid
  permissionId   String  @db.Uuid
  isAllowed      Boolean @default(true)

  user         User         @relation(fields: [userId], references: [id])
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id])
  permission   Permission   @relation(fields: [permissionId], references: [id])

  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, businessUnitId, permissionId])
  @@index([userId, businessUnitId])
}

// ============================================================================
// STRATEGIC PLANNING: StrategicPlan, Values, Factors, Objectives, Indicators
// ============================================================================

/// Plan estratégico de una BU (dueña del plan).
model StrategicPlan {
  id                   String    @id @default(uuid()) @db.Uuid
  name                 String    @db.VarChar(500)
  description          String?   @db.VarChar(1000)
  order                Int       @default(0)
  period               Int?
  fromAt               DateTime?
  untilAt              DateTime?
  mission              String?   @db.VarChar(5000)
  vision               String?   @db.VarChar(5000)
  competitiveAdvantage String?   @db.VarChar(5000)
  status               String    @default("OPE") @db.VarChar(3)

  businessUnitId String       @db.Uuid
  businessUnit   BusinessUnit @relation(fields: [businessUnitId], references: [id])

  // Relaciones
  values     StrategicValue[]
  factors    StrategicSuccessFactor[]
  objectives Objective[]
  projects   StrategicProject[]

  // Inverso hacia Position (posiciones que “pertenecen” al plan)
  positions Position[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Valores corporativos del plan.
model StrategicValue {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  strategicPlanId String        @db.Uuid
  strategicPlan   StrategicPlan @relation(fields: [strategicPlanId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Factores clave de éxito del plan.
model StrategicSuccessFactor {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  strategicPlanId String        @db.Uuid
  strategicPlan   StrategicPlan @relation(fields: [strategicPlanId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Objetivo estratégico (con jerarquía e indicador).
model Objective {
  id               String  @id @default(uuid()) @db.Uuid
  name             String  @db.VarChar(500)
  description      String? @db.VarChar(1000)
  order            Int     @default(0)
  perspective      String  @default("FIN") @db.VarChar(3)
  level            String  @default("EST") @db.VarChar(3)
  valueOrientation String  @default("CRE") @db.VarChar(3)
  goalValue        Float?  @default(0)
  status           String  @default("OPE")

  // Dueño del objetivo
  positionId String   @db.Uuid
  position   Position @relation(fields: [positionId], references: [id])

  // Plan al que pertenece
  strategicPlanId String        @db.Uuid
  strategicPlan   StrategicPlan @relation(fields: [strategicPlanId], references: [id])

  // Indicador 1:1 (configurable)
  indicatorId String?    @db.Uuid
  indicator   Indicator? @relation(fields: [indicatorId], references: [id])

  // Jerarquía de objetivos
  objectiveParentId String?     @db.Uuid
  parent            Objective?  @relation("ObjectiveHierarchy", fields: [objectiveParentId], references: [id])
  children          Objective[] @relation("ObjectiveHierarchy")

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones derivadas
  objectiveGoals    ObjectiveGoal[]
  objectiveGoalsHis ObjectiveGoalHist[]
  strategicProjects StrategicProject[]
  priorities        Priority[]
}

/// Indicador de desempeño (periodicidad, tendencia, etc.).
model Indicator {
  id           String    @id @default(uuid()) @db.Uuid
  name         String    @db.VarChar(500)
  description  String?   @db.VarChar(1000)
  order        Int       @default(0)
  formula      String?   @db.VarChar(1000)
  isDefault    Boolean   @default(false)
  isConfigured Boolean   @default(false)
  origin       String?   @default("MAN")
  tendence     String?   @default("POS")
  frequency    String?   @default("MES")
  measurement  String?   @default("POR")
  type         String?   @default("GES")
  reference    String?
  periodStart  DateTime?
  periodEnd    DateTime?

  // Inverso a objetivos (1 indicador puede usarse en varios)
  objectives Objective[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Meta mensualizada de un objetivo (clave: objectiveId + month + year).
model ObjectiveGoal {
  id String @id @default(uuid()) @db.Uuid

  month Int
  year  Int

  goalPercentage    Float? @default(100)
  goalValue         Float? @default(0)
  realPercentage    Float? @default(0)
  realValue         Float?
  indexCompliance   Float? @default(0)
  score             Float? @default(100)
  rangeExceptional  Float? @default(0)
  rangeInacceptable Float? @default(0)
  indexPerformance  Float? @default(0)
  baseValue         Float? @default(0)
  light             Float? @default(0)

  observation String? @db.Text
  action      String? @db.Text

  objectiveId String    @db.Uuid
  objective   Objective @relation(fields: [objectiveId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([objectiveId, month, year])
}

/// Historial de metas (versionado soft).
model ObjectiveGoalHist {
  id          String @id @default(uuid()) @db.Uuid
  objectiveId String @db.Uuid
  month       Int
  year        Int

  goalPercentage    Float?
  goalValue         Float?
  realPercentage    Float?
  realValue         Float?
  indexCompliance   Float?
  score             Float?
  rangeExceptional  Float?
  rangeInacceptable Float?
  indexPerformance  Float?
  baseValue         Float?
  light             Float?

  observation String? @db.Text
  action      String? @db.Text

  wasActive  Boolean
  archivedAt DateTime @default(now())
  archivedBy String?  @db.Uuid

  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  objective Objective @relation(fields: [objectiveId], references: [id])

  @@index([objectiveId, year, month])
}

// ============================================================================
// PROJECTS: StrategicProject, Factors, Participants, Tasks
// ============================================================================

/// Proyecto estratégico ligado a un plan/posición/objetivo (opcional).
model StrategicProject {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  // Fechas y estado
  fromAt     DateTime?
  untilAt    DateTime?
  finishedAt DateTime?
  canceledAt DateTime?
  status     String    @default("OPE")
  budget     Float?

  // Pertenencia
  strategicPlanId String        @db.Uuid
  strategicPlan   StrategicPlan @relation(fields: [strategicPlanId], references: [id])

  positionId String   @db.Uuid
  position   Position @relation(fields: [positionId], references: [id])

  objectiveId String?    @db.Uuid
  objective   Objective? @relation(fields: [objectiveId], references: [id])

  // Relaciones
  factors      ProjectFactor[]
  participants ProjectParticipant[]

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Factor/entregable del proyecto.
model ProjectFactor {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  result      String? @db.VarChar(1000)
  projectId   String  @db.Uuid
  order       Int     @default(0)

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  project StrategicProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   ProjectTask[]

  @@index([projectId])
}

/// Participante (posición) del proyecto.
model ProjectParticipant {
  id       String  @id @default(uuid()) @db.Uuid
  isLeader Boolean @default(false)

  projectId  String @db.Uuid
  positionId String @db.Uuid

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  project  StrategicProject @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  position Position         @relation(fields: [positionId], references: [id])

  tasks ProjectTask[]

  @@unique([projectId, positionId])
  @@index([projectId])
  @@index([positionId])
}

/// Tarea del proyecto (con fechas y estado).
model ProjectTask {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  fromAt     DateTime  @db.Date
  untilAt    DateTime  @db.Date
  finishedAt DateTime? @db.Date

  status      String  @default("OPE") @db.VarChar(3)
  props       String? @db.VarChar(1000)
  result      String? @db.VarChar(1000)
  methodology String? @db.VarChar(1000)
  budget      Decimal @default(0)
  limitation  String? @db.VarChar(1000)
  comments    String? @db.VarChar(1000)

  projectFactorId      String @db.Uuid
  projectParticipantId String @db.Uuid

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  factor      ProjectFactor      @relation(fields: [projectFactorId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  participant ProjectParticipant @relation(fields: [projectParticipantId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([projectFactorId])
  @@index([projectParticipantId])
}

/// Palanca (lever) asociada a una posición.
model Lever {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  positionId String   @db.Uuid
  position   Position @relation(fields: [positionId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Prioridad con fecha y estado.
model Priority {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @db.VarChar(500)
  description String? @db.VarChar(1000)
  order       Int     @default(0)

  fromAt     DateTime  @db.Date
  untilAt    DateTime  @db.Date
  finishedAt DateTime? @db.Date
  canceledAt DateTime? @db.Date

  month Int?
  year  Int?

  status String @default("OPE") @db.VarChar(3) // OPE | CLO | CAN

  positionId String   @db.Uuid
  position   Position @relation(fields: [positionId], references: [id])

  objectiveId String?    @db.Uuid
  objective   Objective? @relation(fields: [objectiveId], references: [id])

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([positionId])
  @@index([objectiveId])
  @@index([status])
  @@index([year, month])
  @@index([untilAt])
}

// ============================================================================
// FILES & COMMENTS
// ============================================================================

/// Archivos adjuntos/medios relacionados a entidades (por shortcode+referenceId).
model File {
  id              String   @id @default(uuid())
  fieldName       String?
  description     String?
  originalName    String?
  encoding        String?
  mimeType        String?
  destination     String?
  fileName        String?
  path            String?
  sizeByte        Decimal?
  extension       String?
  icon            String?
  moduleShortcode String?
  referenceId     String?  @db.Uuid
  screenKey       String? // p.ej. "logo", "avatar", "attachments", "banner"

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleShortcode, referenceId], name: "idx_files_module_ref")
  @@index([moduleShortcode, referenceId, screenKey], name: "idx_files_module_ref_screen")
  @@map("files")
}

/// Plantillas de notificación (texto/subject/plantilla parametrizable).
model NotificationTemplate {
  id           String  @id @default(uuid())
  name         String  @db.VarChar(500)
  subject      String? @db.VarChar(1000)
  codeTemplate String  @unique @db.Char(3)
  template     String  @db.Text

  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

/// Comentarios genéricos por referencia (módulo+referencia).
model Comment {
  id              String  @id @default(uuid()) @db.Uuid
  name            String  @db.VarChar(1000)
  moduleShortcode String? @db.VarChar(20)
  referenceId     String  @db.Uuid

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([referenceId])
}

// ============================================================================
// SYSTEM SETTINGS (Parámetros por Company + BusinessUnit)
// ============================================================================

/// Parámetros por Compañía + Unidad de Negocio (scoping obligatorio).
/// Ejemplos:
/// - NOTIF_EMAIL_ENABLED → { "enabled": false }
/// - NOTIF_QUIET_HOURS   → { "start":"22:00","end":"07:00","timezone":"America/Guayaquil" }
/// - NOTIF_DEFAULT_CHANNELS → reglas de canales por evento
model SystemSetting {
  id String @id @default(uuid()) @db.Uuid

  companyId      String @db.Uuid
  businessUnitId String @db.Uuid

  company      Company      @relation(fields: [companyId], references: [id])
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id])

  key      String  @db.VarChar(80)
  value    Json
  isActive Boolean @default(true)

  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, businessUnitId, key])
  @@index([companyId, businessUnitId, key])
}

// ============================================================================
// NOTIFICATIONS MODULE
// ----------------------------------------------------------------------------
// - Notification: 1 fila por canal (IN_APP, EMAIL, ...)
// - NotificationDelivery: trazabilidad por proveedor/canal
// - Usa DB+Cron para scheduling; escalable a BullMQ
// - Dedupe por usuario+entidad+evento+día+canal (dedupeKey)
// - Relacionado a Company y BusinessUnit con inversos en ambos
// ============================================================================

/// Entidad origen de la notificación.
enum NotificationEntity {
  PRIORITY
  TASK
  OBJECTIVE
  OBJECTIVE_GOAL
  PROJECT
}

/// Eventos soportados por el sistema de notificaciones.
/// ASSIGNED           → inmediata
/// UPDATED            → cambios relevantes (fecha/owner)
/// DUE_SOON          → programada (-4d, -1d)
/// OVERDUE           → programada (al vencer)
/// COMPLETED         → cierre
/// APPROVAL_*        → flujos de aprobación
enum NotificationEvent {
  ASSIGNED
  UPDATED
  DUE_SOON
  OVERDUE
  COMPLETED
  REOPENED
  APPROVAL_REQUESTED
  APPROVED
  REJECTED
}

/// Canales de entrega. V1: IN_APP + EMAIL. Futuro: PUSH/SMS/WH/WEBHOOK.
enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
  WHATSAPP
  WEBHOOK
}

/// Estado del job de notificación.
/// PEN → pendiente; SENT → enviada; READ → leída; EXP → expirada; FLD → fallida.
enum NotificationStatus {
  PEN
  SENT
  READ
  EXP
  FLD
}

/// Registro de notificación (una fila por canal).
model Notification {
  id String @id @default(uuid()) @db.Uuid

  // Scoping multiempresa
  companyId      String       @db.Uuid
  businessUnitId String       @db.Uuid
  company        Company      @relation(fields: [companyId], references: [id])
  businessUnit   BusinessUnit @relation(fields: [businessUnitId], references: [id])

  // Destinatario
  recipientId String @db.Uuid
  recipient   User   @relation(fields: [recipientId], references: [id])

  // Origen del evento
  entityType NotificationEntity
  entityId   String             @db.Uuid

  // Evento y canal
  event   NotificationEvent
  channel NotificationChannel

  // Contenido resuelto (desde plantilla + variables)
  title   String @db.VarChar(500)
  message String @db.VarChar(1000)
  payload Json?

  // Estado y programación
  status      NotificationStatus @default(PEN)
  scheduledAt DateTime? // si es programada (DUE_SOON/OVERDUE)
  sentAt      DateTime?
  readAt      DateTime?
  expiresAt   DateTime?

  // Dedupe: usuario + entidad + evento + día + canal
  dedupeKey String @db.VarChar(160)

  // Auditoría
  isActive  Boolean  @default(true)
  createdBy String?  @db.Uuid
  updatedBy String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trazabilidad de envío por proveedor/canal
  deliveries NotificationDelivery[]

  @@unique([recipientId, entityType, entityId, event, channel, dedupeKey])
  @@index([recipientId, status, scheduledAt])
  @@index([companyId, businessUnitId])
  @@index([entityType, entityId, event])
}

/// Log de entrega por proveedor (SES/SendGrid/FCM…).
model NotificationDelivery {
  id String @id @default(uuid()) @db.Uuid

  notificationId String       @db.Uuid
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  provider          String  @db.VarChar(50) // "ses", "sendgrid", "fcm"...
  providerMessageId String? @db.VarChar(120)
  status            String  @db.VarChar(30) // delivered, bounced, complaint...
  meta              Json? // payloads de webhook / detalles

  createdAt DateTime @default(now())

  @@index([notificationId])
}

// ============================================================================
// MEETINGS MODULE
// ============================================================================

/// Frecuencia de la recurrencia de una reunión.
enum MeetingFrequency {
  ONCE // Reunión única
  DAILY // Diario
  WEEKLY // Semanal
  BIWEEKLY // Quincenal (cada 2 semanas)
  MONTHLY // Mensual
}

/// Estado de la serie de reuniones.
enum MeetingStatus {
  ACTIVE // La serie está activa y genera ocurrencias.
  CANCELLED // La serie ha sido cancelada, no generará más ocurrencias.
}

/// Rol de un participante en una reunión.
enum MeetingParticipantRole {
  CONVENER // El convocante, responsable de la reunión.
  PARTICIPANT // Un participante.
}

/// Define la serie de una reunión y sus reglas de recurrencia.
/// Es la "plantilla" de la cual se generan las ocurrencias.
model Meeting {
  id        String  @id @default(uuid()) @db.Uuid
  name      String  @db.VarChar(500)
  purpose   String? @db.Text
  location  String? @db.VarChar(500) // Puede ser un lugar físico o un enlace a una videollamada.
  tools     String? @db.Text // Herramientas para el análisis, formato libre.

  // --- Multi-empresa ---
  companyId      String       @db.Uuid
  company        Company      @relation(fields: [companyId], references: [id])
  businessUnitId String?      @db.Uuid
  businessUnit   BusinessUnit? @relation(fields: [businessUnitId], references: [id])

  // --- Campos de Recurrencia ---
  frequency     MeetingFrequency
  startDate     DateTime // Fecha y hora de inicio de la primera ocurrencia. Define el "ancla" de la serie.
  endDate       DateTime // Fecha y hora de fin de la primera ocurrencia.
  // Opcional: fecha de fin de la serie. Si es null, la serie es indefinida (o hasta un horizonte de generación).
  seriesEndDate DateTime?
  // Para recurrencia mensual, especifica el día del mes (1-31).
  // Para recurrencia semanal/quincenal, el día de la semana (0=Domingo, 1=Lunes...).
  dayValue      Int?
  daysOfWeek    Int[] // Array de días para recurrencia múltiple (ej: [1, 3, 5] para Lun, Mie, Vie)

  // --- Estado y Auditoría ---
  status    MeetingStatus @default(ACTIVE)
  createdBy String        @db.Uuid // ID del usuario convocante.
  creator   User          @relation("MeetingCreator", fields: [createdBy], references: [id])
  updatedBy String?       @db.Uuid
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // --- Relaciones ---
  // Ocurrencias generadas a partir de esta serie.
  occurrences  MeetingOccurrence[]
  // Participantes de la serie.
  participants MeetingParticipant[]

  // --- Espacio para futuras integraciones ---
  // IDs para sincronización con calendarios externos.
  googleCalendarId  String? @unique
  outlookCalendarId String? @unique

  @@index([createdBy])
}

/// Representa una instancia específica de una reunión en una fecha y hora concretas.
/// Esto es lo que se muestra en el calendario.
model MeetingOccurrence {
  id        String   @id @default(uuid()) @db.Uuid
  meetingId String   @db.Uuid
  meeting   Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  startDate DateTime
  endDate   DateTime
  isExecuted  Boolean  @default(false) // Marcada como 'true' cuando la reunión se ha realizado.
  isCancelled Boolean  @default(false) // Marcada como 'true' si esta ocurrencia específica se cancela.
  updatedBy   String?  @db.Uuid
  updatedAt   DateTime @updatedAt

  @@unique([meetingId, startDate])
  @@index([startDate, endDate])
}

/// Vincula a un usuario con una reunión y define su rol.
model MeetingParticipant {
  id         String                 @id @default(uuid()) @db.Uuid
  meetingId  String                 @db.Uuid
  userId     String                 @db.Uuid
  meeting    Meeting                @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  user       User                   @relation(fields: [userId], references: [id])
  role       MeetingParticipantRole
  isRequired Boolean                @default(true)
  createdBy  String                 @db.Uuid
  createdAt  DateTime               @default(now())

  @@unique([meetingId, userId])
}
